{# templates/_card_macros.html #}
{% macro workout_card(w, size='sm') %}
  {# parts + thumbs #}
  {% set parts  = w.body_parts if w.body_parts else ([w.body_part] if w.body_part else []) %}
  {% set thumbs = (w.images if w.images else []) %}
  {% if w.muscle_image and (w.muscle_image not in thumbs) %}
    {% set thumbs = thumbs + [w.muscle_image] %}
  {% endif %}
  {% if not thumbs or thumbs|length == 0 %}
    {% set thumbs = ['https://via.placeholder.com/900x1600?text=Workout'] %}
  {% endif %}
  {% set cid = 'car-' ~ (w.slug or w._id) %}
  {% set ratio_class = 'card-media-sm' if size=='sm' else ('card-media-md' if size=='md' else 'card-media-lg') %}

  <div class="card h-100 shadow-sm">
    <div id="{{ cid }}" class="carousel slide {{ ratio_class }}" data-bs-ride="false" aria-label="{{ w.name }} images">
      <div class="carousel-inner">
        {% for img in thumbs %}
          <div class="carousel-item {% if loop.first %}active{% endif %}">
            <img src="{{ img }}" class="w-100 h-100" style="object-fit:cover;" alt="{{ w.name }} image {{ loop.index }}">
          </div>
        {% endfor %}
      </div>
      {% if thumbs|length > 1 %}
        <button class="carousel-control-prev" type="button" data-bs-target="#{{ cid }}" data-bs-slide="prev" aria-label="Previous image">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#{{ cid }}" data-bs-slide="next" aria-label="Next image">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
        </button>
      {% endif %}
    </div>

    <div class="card-body py-2 px-2">
      <h6 class="card-title mb-1">
        <a href="{{ url_for('workout_detail', slug=w.slug) }}" class="stretched-link text-decoration-none">
          {{ w.name }}
        </a>
      </h6>
      <div class="small text-muted">
        {{ w.level or '—' }}{% if parts %} • {{ parts|join(', ') }}{% endif %}{% if w.style %} • {{ w.style }}{% endif %}
      </div>
    </div>
  </div>
{% endmacro %}
