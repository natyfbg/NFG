{% extends "base.html" %}
{% block title %}{{ w.name }} – NFG{% endblock %}

{% block sidebar %}
  {% include "quick_options.html" %}
{% endblock %}

{% block content %}
<h1 class="mb-3 page-title">{{ w.name }}</h1>

<div class="row g-4 align-items-start">
  <!-- LEFT: Video + Info/Tips (first on all sizes) -->
  <div class="col-lg-7 order-1">
    {% if w.youtube_id %}
      <div class="ratio ratio-16x9 rounded overflow-hidden shadow mb-3">
        <iframe
          src="https://www.youtube.com/embed/{{ w.youtube_id }}"
          title="YouTube video"
          allowfullscreen
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade">
        </iframe>
      </div>
    {% endif %}

    {% if w.info %}
      <h3 class="h5 mt-3">Info</h3>
      <p class="mb-2">{{ w.info }}</p>
    {% endif %}

    {% if w.tips and w.tips|length %}
      <h3 class="h5 mt-3">Tips</h3>
      <ul class="list-group">
        {% for tip in w.tips %}
          <li class="list-group-item">{{ tip }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  <!-- RIGHT: Portrait gallery + Meta -->
  <div class="col-lg-5 order-2">
    {# Build gallery list: ordered images + muscle diagram (if present) #}
    {% set gallery = (w.images if w.images else []) %}
    {% if w.muscle_image and (w.muscle_image not in gallery) %}
      {% set gallery = gallery + [w.muscle_image] %}
    {% endif %}
    {% if not gallery or gallery|length == 0 %}
      {% set gallery = ['https://via.placeholder.com/900x1600?text=Workout'] %}
    {% endif %}
    {% set cid = 'detail-car-' ~ w.slug %}

    <!-- MAIN PORTRAIT GALLERY (strict 9:16; height follows width) -->
    <div class="media-9x16 rounded overflow-hidden shadow">
      <div id="{{ cid }}" class="carousel slide h-100" data-bs-ride="false">
        <div class="carousel-inner h-100">
          {% for img in gallery %}
            <div class="carousel-item {% if loop.first %}active{% endif %} h-100">
              <img
                src="{{ img }}"
                alt="{{ w.name }} image {{ loop.index }}"
                class="d-block w-100 h-100"
                style="object-fit:cover;"
                {% if loop.first %}loading="eager" fetchpriority="high"{% else %}loading="lazy"{% endif %}
                decoding="async">
            </div>
          {% endfor %}
        </div>

        {% if gallery|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#{{ cid }}" data-bs-slide="prev" aria-label="Previous image">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#{{ cid }}" data-bs-slide="next" aria-label="Next image">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
          </button>
        {% endif %}
      </div>
    </div>

    {% if gallery|length > 1 %}
      <!-- Responsive, scrollable portrait thumbnails -->
      <div class="thumbscroller mt-2">
        {% for img in gallery %}
          <img
            src="{{ img }}"
            data-bs-target="#{{ cid }}"
            data-bs-slide-to="{{ loop.index0 }}"
            class="border thumb-9x16"
            alt="thumbnail {{ loop.index }}"
            loading="lazy"
            decoding="async">
        {% endfor %}
      </div>
    {% endif %}

    <!-- Meta -->
    <ul class="list-group mt-3 detail-meta">
      {% if w.level %}
        <li class="list-group-item">
          <strong>Difficulty:</strong>
          <a href="{{ url_for('workouts_browse', level=w.level) }}">{{ w.level }}</a>
        </li>
      {% endif %}

      {% set parts = w.body_parts if w.body_parts else ([w.body_part] if w.body_part else []) %}
      {% if parts %}
        <li class="list-group-item">
          <strong>Body Part(s):</strong>
          {% for p in parts %}
            <a class="badge rounded-pill text-bg-secondary text-decoration-none me-1"
               href="{{ url_for('workouts_browse', body=p) }}">{{ p }}</a>
          {% endfor %}
        </li>
      {% endif %}

      {% if w.style %}
        <li class="list-group-item">
          <strong>Style:</strong>
          <a href="{{ url_for('workouts_browse', style=w.style) }}">{{ w.style }}</a>
        </li>
      {% endif %}

      {% if w.tags and w.tags|length %}
        <li class="list-group-item">
          <strong>Tags:</strong>
          {% for t in w.tags %}
            <a class="badge rounded-pill text-bg-light border text-decoration-none me-1"
               href="{{ url_for('workouts_browse', q=t) }}">{{ t }}</a>
          {% endfor %}
        </li>
      {% endif %}

      {% if w.rating is not none %}
        <li class="list-group-item"><strong>Rating:</strong> ★ {{ '%.1f'|format(w.rating) }}</li>
      {% endif %}
    </ul>
  </div>
</div> <!-- /row -->

{% if related and related|length %}
  <h3 class="h5 mt-4">Related Workouts</h3>
  <div class="row row-cols-2 row-cols-md-3 g-3">
    {% for r in related %}
      {% set thumbs = (r.images if r.images else []) %}
      {% if r.muscle_image and (r.muscle_image not in thumbs) %}
        {% set thumbs = thumbs + [r.muscle_image] %}
      {% endif %}
      {% if not thumbs or thumbs|length == 0 %}
        {% set thumbs = ['https://via.placeholder.com/900x1600?text=Workout'] %}
      {% endif %}
      {% set rcid = 'rel-' ~ r.slug %}
      {% set rparts = r.body_parts if r.body_parts else ([r.body_part] if r.body_part else []) %}

      <div class="col">
        <!-- Whole card is strict 9:16; caption overlays -->
        <div class="card portrait-card shadow overflow-hidden">
          <div class="card-media position-relative h-100">
            <div id="{{ rcid }}" class="carousel slide h-100" data-bs-ride="false">
              <div class="carousel-inner h-100">
                {% for img in thumbs %}
                  <div class="carousel-item {% if loop.first %}active{% endif %} h-100">
                    <img
                      src="{{ img }}"
                      alt="{{ r.name }} image {{ loop.index }}"
                      class="d-block w-100 h-100"
                      style="object-fit:cover;"
                      loading="lazy"
                      decoding="async">
                  </div>
                {% endfor %}
              </div>

              {% if thumbs|length > 1 %}
                <button class="carousel-control-prev" type="button" data-bs-target="#{{ rcid }}" data-bs-slide="prev" aria-label="Previous image">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#{{ rcid }}" data-bs-slide="next" aria-label="Next image">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                </button>
              {% endif %}
            </div>

            <div class="card-caption">
              <h6 class="mb-1">
                <a class="stretched-link text-white text-decoration-none" href="{{ url_for('workout_detail', slug=r.slug) }}">
                  {{ r.name }}
                </a>
              </h6>
              <div class="small opacity-75">
                {{ r.level or '—' }}{% if rparts %} • {{ rparts|join(', ') }}{% endif %}{% if r.style %} • {{ r.style }}{% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<a class="btn btn-secondary mt-4" href="{{ url_for('workouts_browse') }}">← Back to Browse</a>

<style>
  /* ================= Responsive knobs ================= */
  :root{
    /* Use *small* and *dynamic* viewport units to handle mobile browser chrome. */
    --gallery-max-vh: 78svh;  /* small-viewport height cap */
    --gallery-max-dvh: 78dvh; /* dynamic-viewport fallback */
  }

  /* Title scales a bit across sizes */
  h1.page-title{ font-size: clamp(1.75rem, 2.5vw, 2.25rem); }

  /* ======== Detail main portrait (right column) ======== */
  .media-9x16{
    aspect-ratio: 9 / 16;
    width: 100%;
    /* Height follows width; cap to viewport height to prevent overflow on phones */
    max-height: min(var(--gallery-max-vh), var(--gallery-max-dvh));
  }
  .media-9x16 img{ width:100%; height:100%; object-fit:cover; }

  /* On the *smallest* screens, also limit width so 9:16 doesn't grow too tall */
  @media (max-width: 480px){
    .media-9x16{
      /* keep some gutters and shrink a touch so thumbs/meta fit without overflow */
      width: min(92vw, 420px);
      margin-inline: auto;
      max-height: min(72svh, 72dvh);
    }
    .thumbscroller{ justify-content: center; }
  }

  /* ======== Portrait cards (related) ======== */
  .portrait-card{ aspect-ratio: 9 / 16; width:100%; }
  .portrait-card .card-media{ width:100%; height:100%; }
  .portrait-card img{ width:100%; height:100%; object-fit:cover; }

  .card-caption{
    position:absolute; left:0; right:0; bottom:0;
    padding:.6rem .75rem; color:#fff;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 60%, rgba(0,0,0,.78) 100%);
  }

  /* ======== Thumbnails: responsive + scrollable row ======== */
  .thumb-9x16{
    --t: clamp(48px, 10vw, 64px);  /* width adapts 48→64px */
    width: var(--t);
    height: calc((16 / 9) * var(--t));
    object-fit: cover;
    border-radius: .375rem;
    cursor: pointer;
  }
  .thumbscroller{
    display:flex; gap:.5rem; flex-wrap:nowrap;
    overflow-x:auto; padding-bottom:.25rem;
    scroll-snap-type:x proximity; -webkit-overflow-scrolling: touch;
  }
  .thumbscroller img{ scroll-snap-align:center; }

  /* Tighter meta spacing on very small screens */
  @media (max-width: 575.98px){
    .detail-meta .list-group-item{ padding:.5rem .75rem; }
  }

  /* Carousel controls wider on tall media */
  .card .carousel-control-prev,
  .card .carousel-control-next { width: 14%; }
</style>

<script>
  // Prevent arrow clicks from triggering overlay/stretched links
  document.querySelectorAll('.carousel-control-prev, .carousel-control-next')
    .forEach(btn => btn.addEventListener('click', e => e.stopPropagation()));

  // Thumbnail click → jump to that slide
  document.querySelectorAll('img.thumb-9x16').forEach(el => {
    el.addEventListener('click', function () {
      const target = this.getAttribute('data-bs-target');
      const idx = parseInt(this.getAttribute('data-bs-slide-to'), 10);
      const elCar = document.querySelector(target);
      if (!elCar) return;
      const instance = bootstrap.Carousel.getOrCreateInstance(elCar);
      instance.to(idx);
    });
  });
</script>
{% endblock %}
