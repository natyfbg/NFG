{% extends "base.html" %}
{% block title %}Search “{{ q }}” – NFG{% endblock %}

{% block sidebar %}
  {% include "quick_options.html" %}
{% endblock %}

{% block content %}
<h1 class="mb-1">Search results</h1>
<p class="text-muted mb-3">
  “{{ q }}” • {{ total }} workout{{ '' if total==1 else 's' }}
</p>

{% if total == 0 %}
  <div class="alert alert-secondary">
    No workouts matched “{{ q }}”.
    Try <a href="{{ url_for('workouts_browse', q=q) }}">Browse</a> with filters.
  </div>
{% else %}
  {# --- Pills: allow clearing the search --- #}
  <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
    <a class="badge rounded-pill text-bg-primary text-decoration-none"
       href="{{ url_for('search', q='') }}">
      Search: “{{ q }}” ✕
    </a>
    <a class="badge rounded-pill text-bg-danger text-decoration-none"
       href="{{ url_for('workouts_browse') }}">Clear all</a>
  </div>

  {# ===== Thumbnail grid with in-card image carousel (16:9 like Browse) ===== #}
  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
    {% for w in items %}
      {% set parts  = w.body_parts if w.body_parts else ([w.body_part] if w.body_part else []) %}
      {% set thumbs = (w.images if w.images else ([])) %}
      {% if (not thumbs or thumbs|length == 0) and w.muscle_image %}
        {% set thumbs = [w.muscle_image] %}
      {% endif %}
      {% if not thumbs or thumbs|length == 0 %}
        {% set thumbs = ['https://via.placeholder.com/800x450?text=Image+Coming+Soon'] %}
      {% endif %}
      {% set cid = 'car-s-' ~ w.slug %}

      <div class="col">
        <div class="card h-100 shadow-sm">
          <div id="{{ cid }}" class="carousel slide" data-bs-ride="false">
            <div class="carousel-inner ratio ratio-16x9">
                  {% for img in thumbs %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                      <img
                        src="{{ img }}"
                        class="d-block w-100 h-100"
                        style="object-fit: cover;"
                        alt="{{ w.name }} image {{ loop.index }}"
                        {% if loop.first %}loading="eager" fetchpriority="high"{% else %}loading="lazy"{% endif %}
                        decoding="async">
                    </div>
                  {% endfor %}
                </div>

            {% if thumbs|length > 1 %}
              <button class="carousel-control-prev" type="button" data-bs-target="#{{ cid }}" data-bs-slide="prev" aria-label="Previous image">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#{{ cid }}" data-bs-slide="next" aria-label="Next image">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
              </button>
            {% endif %}
          </div>

          <div class="card-body">
            <h5 class="card-title mb-1">
              <a href="{{ url_for('workout_detail', slug=w.slug) }}" class="stretched-link text-decoration-none">
                {{ w.name }}
              </a>
            </h5>
            <div class="small text-muted">
              {{ w.level }}{% if parts %} • {{ parts|join(', ') }}{% endif %}{% if w.style %} • {{ w.style }}{% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  {# Pagination #}
  <nav class="mt-3">
    <ul class="pagination">
      <li class="page-item {% if page<=1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('search', q=q, page=page-1, per_page=per_page) }}">Previous</a>
      </li>
      <li class="page-item disabled"><span class="page-link">Page {{ page }}</span></li>
      <li class="page-item {% if (page*per_page) >= total %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('search', q=q, page=page+1, per_page=per_page) }}">Next</a>
      </li>
    </ul>
  </nav>
{% endif %}

{# Optional: show matched recipes quickly below #}
{% if recipes and recipes|length > 0 %}
  <hr class="my-4">
  <h2 class="h5">Recipes (by name)</h2>
  <ul class="list-group">
    {% for r in recipes %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ r.name }}</span>
      </li>
    {% endfor %}
  </ul>
{% endif %}
{% endblock %}
